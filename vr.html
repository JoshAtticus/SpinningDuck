<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spinning Duck^3</title>
    <link rel="icon" href="duck.png" type="image/png">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script defer data-domain="duck.joshattic.us" src="https://plausible.joshatticus.site/js/script.file-downloads.outbound-links.js"></script>
    <style>
        #overlay {
            position: absolute;
            z-index: 999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        button {
            padding: 12px 24px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        footer {
            position: absolute;
            bottom: 10px;
            font-size: 0.9rem;
            color: #333;
            font-family: sans-serif;
            text-align: center;
        }
        h1 {
            font-family: sans-serif;
        }
    </style>
    <script>
        AFRAME.registerComponent('spin-thing', {
            schema: {
                speed: {type: 'number', default: 1},
                axis: {type: 'string', default: 'y'}
            },
            tick: function (time, timeDelta) {
                const rotation = (this.data.speed * timeDelta) / 1000;
                if (this.data.axis === 'x') this.el.object3D.rotation.x += rotation;
                if (this.data.axis === 'y') this.el.object3D.rotation.y += rotation;
                if (this.data.axis === 'z') this.el.object3D.rotation.z += rotation;
            }
        });

        AFRAME.registerComponent('chase-player', {
            schema: {
                speed: {type: 'number', default: 0.5},
                minDistance: {type: 'number', default: 1}
            },
            tick: function (time, timeDelta) {
                // Get camera from scene if valid
                const camera = this.el.sceneEl.camera;
                if (!camera) return;
                
                // Get positions
                const targetPos = new THREE.Vector3();
                camera.el.object3D.getWorldPosition(targetPos);
                
                const currentPos = new THREE.Vector3();
                this.el.object3D.getWorldPosition(currentPos);
                
                // Calculate direction vector
                const direction = new THREE.Vector3().subVectors(targetPos, currentPos);
                const distance = direction.length();
                
                // Stop if too close (and maybe bob in place?)
                if (distance < this.data.minDistance) {
                    return;
                }
                
                // Normalize and scale by speed
                direction.normalize().multiplyScalar((this.data.speed * timeDelta) / 1000);
                
                // Move towards player
                this.el.object3D.position.add(direction);
                
                // Face the player
                this.el.object3D.lookAt(targetPos);
            }
        });

        AFRAME.registerComponent('controller-duck', {
            init: function() {
                // Create a small duck video plane attached to the controller
                const duck = document.createElement('a-video');
                duck.setAttribute('src', '#duckVideo');
                duck.setAttribute('width', '0.3');
                duck.setAttribute('height', '0.17');
                duck.setAttribute('position', '0 0.1 0');
                duck.setAttribute('rotation', '-90 0 0'); // Face up
                duck.setAttribute('spin-thing', 'speed: 2; axis: z');
                this.el.appendChild(duck);
            }
        });

        AFRAME.registerComponent('teleport-reset', {
            init: function() {
                this.hudMessage = document.querySelector('#hud-message');
                this.timer = null;
            },
            tick: function () {
                const camera = this.el.sceneEl.camera;
                if (!camera) return;
                
                // Get world position of the camera (which moves inside the rig)
                const position = new THREE.Vector3();
                camera.el.object3D.getWorldPosition(position);
                
                // Check distance from origin (0, 0, 0)
                const distance = position.length();

                if (distance > 20) {
                    // Reset rig position
                    const rig = document.querySelector('#rig');
                    if (rig) rig.object3D.position.set(0, 0, 0);

                    // Reset camera local position if wasd-controls are being used heavily
                    camera.el.object3D.position.set(0, 1.6, 0);

                    // Show message
                    if (this.hudMessage) {
                        this.hudMessage.setAttribute('visible', true);
                        this.hudMessage.setAttribute('value', "You can run, but in the end, DUCK.");
                        
                        if (this.timer) clearTimeout(this.timer);
                        this.timer = setTimeout(() => {
                            this.hudMessage.setAttribute('visible', false);
                        }, 5000);
                    }
                }
            }
        });
    </script>
</head>
<body>
    <div id="overlay">
        <h1>VR Duck Universe</h1>
        <button id="enterVRButton">Enter the Duck Dimension</button>
        <footer id="footer">
            &copy; 2025 JoshAtticus | <a href="https://github.com/JoshAtticus/SpinningDuck" target="_blank" rel="noopener noreferrer">View on GitHub</a> | <a href="index.html">Modern</a> | <a href="legacy.html">Legacy</a>
        </footer>
    </div>

    <a-scene teleport-reset>
        <a-assets>
            <video id="duckVideo" src="duck.mp4" loop playsinline crossorigin="anonymous"></video>
        </a-assets>

        <!-- Player Rig for movement -->
        <a-entity id="rig" position="0 0 0">
            <a-entity camera position="0 1.6 0" look-controls wasd-controls>
                <!-- HUD Message Text attached to face -->
                <a-text id="hud-message" 
                        value="" 
                        position="0 0 -1" 
                        align="center" 
                        width="2" 
                        color="#FF0000" 
                        font="exo2bold"
                        visible="false"
                        material="shader: flat; depthTest: false"
                        z-index="999">
                </a-text>
            </a-entity>
            <!-- Controllers with Duck attached -->
            <a-entity oculus-touch-controls="hand: left" laser-controls="hand: left" raycaster="objects: .clickable" controller-duck></a-entity>
            <a-entity oculus-touch-controls="hand: right" laser-controls="hand: right" raycaster="objects: .clickable" controller-duck></a-entity>
        </a-entity>

        <!-- The Prime Duck (Front) with Spatial Audio -->
        <a-video src="#duckVideo" position="0 1.6 -2" width="4" height="2.25" spin-thing="speed: 0.5"></a-video>
        
        <!-- Spatial Audio Emitter linked to the video -->
        <a-entity position="0 1.6 -2" sound="src: #duckVideo; autoplay: true; loop: true; distanceModel: exponential; rolloffFactor: 1"></a-entity>

        <!-- Surround Ducks (The Cube of Duck) -->
        <a-video src="#duckVideo" position="3 1.6 0" rotation="0 -90 0" width="4" height="2.25" spin-thing="speed: 0.8"></a-video>
        <a-entity position="3 1.6 0" sound="src: #duckVideo; autoplay: true; loop: true; distanceModel: exponential; rolloffFactor: 2"></a-entity>

        <a-video src="#duckVideo" position="-3 1.6 0" rotation="0 90 0" width="4" height="2.25" spin-thing="speed: 0.8"></a-video>
        <a-entity position="-3 1.6 0" sound="src: #duckVideo; autoplay: true; loop: true; distanceModel: exponential; rolloffFactor: 2"></a-entity>

        <a-video src="#duckVideo" position="0 1.6 3" rotation="0 180 0" width="4" height="2.25" spin-thing="speed: 0.5"></a-video>
        <a-entity position="0 1.6 3" sound="src: #duckVideo; autoplay: true; loop: true; distanceModel: exponential; rolloffFactor: 2"></a-entity>

        <a-video src="#duckVideo" position="0 4 0" rotation="90 0 0" width="4" height="2.25" spin-thing="speed: 1.2"></a-video>
        <a-entity position="0 4 0" sound="src: #duckVideo; autoplay: true; loop: true; distanceModel: exponential; rolloffFactor: 2"></a-entity>

        <a-video src="#duckVideo" position="0 -1 0" rotation="-90 0 0" width="4" height="2.25" spin-thing="speed: 1.2"></a-video>
        <a-entity position="0 -1 0" sound="src: #duckVideo; autoplay: true; loop: true; distanceModel: exponential; rolloffFactor: 2"></a-entity>
        
        <!-- Dynamic Duck Spawner will inject more ducks here -->
        <a-entity id="duck-swarm"></a-entity>

        <!-- Ambient lighting -->
        <a-sky color="#000000"></a-sky>
    </a-scene>

    <script>
        const video = document.getElementById('duckVideo');
        const button = document.getElementById('enterVRButton');
        const overlay = document.getElementById('overlay');
        const scene = document.querySelector('a-scene');
        const duckSwarm = document.getElementById('duck-swarm');

        button.addEventListener('click', () => {
            overlay.style.display = 'none';
            video.play();
            // Enter VR mode automatically if possible, or just start the scene
            scene.enterVR();
        });
        
        // Handle exiting VR to show overlay again if desired, but for now simple is fine.
        scene.addEventListener('exit-vr', () => {
             // Maybe pause video?
             video.pause();
             overlay.style.display = 'flex';
        });

        // Spawn MORE DUCK
        function spawnDucks() {
            const numberOfDucks = 50;
            const chaseChance = 0.2; // 20% of ducks will chase you

            for (let i = 0; i < numberOfDucks; i++) {
                const el = document.createElement('a-video');
                el.setAttribute('src', '#duckVideo');
                
                // Random position in a sphere around player (radius 5-15)
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos((Math.random() * 2) - 1);
                const radius = 5 + Math.random() * 10;
                
                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta) + 1.6;
                const z = radius * Math.cos(phi);

                el.setAttribute('position', `${x} ${y} ${z}`);
                
                // Random size
                const scale = 0.5 + Math.random() * 1.5;
                el.setAttribute('width', 1.6 * scale); // maintain aspect ratioish
                el.setAttribute('height', 0.9 * scale);
                
                // Look at center
                el.setAttribute('look-at', '0 1.6 0');

                // Determine behavior
                if (Math.random() < chaseChance) {
                    // Chasing duck - FASTER
                    el.setAttribute('chase-player', `speed: ${1.5 + Math.random() * 3}; minDistance: 0.5`);
                    // Sound
                    el.setAttribute('sound', {
                        src: '#duckVideo',
                        autoplay: true,
                        loop: true,
                        distanceModel: 'exponential',
                        rolloffFactor: 5,
                        volume: 0.5
                    });
                } else {
                    // Just spinning duck
                    const axis = Math.random() > 0.66 ? 'x' : (Math.random() > 0.33 ? 'y' : 'z');
                    // Add sound to spinners
                    el.setAttribute('sound', {
                        src: '#duckVideo',
                        autoplay: true,
                        loop: true,
                        distanceModel: 'exponential',
                        rolloffFactor: 10,
                        volume: 0.2
                    });

                    const speed = 1 + Math.random() * 5; // fast spin
                    el.setAttribute('spin-thing', `speed: ${speed}; axis: ${axis}`);
                }

                duckSwarm.appendChild(el);
            }
        }

        // Initialize swarm
        spawnDucks();
    </script>
</body>
</html>